import io
import os
import tempfile

from fastapi import FastAPI, HTTPException
from fastapi.responses import Response
from pydantic import BaseModel

import torch
import soundfile as sf

from qwen_tts import Qwen3TTSModel

MODEL_ID = os.environ.get("QWEN_TTS_MODEL", "Qwen/Qwen3-TTS-12Hz-0.6B-CustomVoice")
DEVICE = "cuda:0" if torch.cuda.is_available() else "cpu"

# GTX 1080: fp16 on CUDA is the right default; bf16 is not supported on Pascal.
DTYPE = torch.float16 if DEVICE.startswith("cuda") else torch.float32

DEFAULT_VOICE = os.environ.get("QWEN_VOICE", "vivian")
DEFAULT_LANG = os.environ.get("QWEN_LANG", "English")

app = FastAPI()

class SpeakReq(BaseModel):
    text: str
    voice: str | None = None
    language: str | None = None
    instructions: str | None = None

print(f"[qwen-speak] loading model={MODEL_ID} device={DEVICE} dtype={DTYPE}")
model = Qwen3TTSModel.from_pretrained(
    MODEL_ID,
    device_map=DEVICE,
    dtype=DTYPE,
)

@app.post("/speak")
def speak(req: SpeakReq):
    text = (req.text or "").strip()
    if not text:
        return {"ok": True, "skipped": "empty text"}

    voice = req.voice or DEFAULT_VOICE
    language = req.language or DEFAULT_LANG

    try:
        # qwen-tts 0.1.1: model.generate(...) returns (waveform, sample_rate)
        wav, sr = model.generate(
            text=text,
            voice=voice,
            language=language,
            instructions=req.instructions,
        )
    except TypeError as e:
        # If signature differs, print a helpful error
        raise HTTPException(status_code=500, detail=f"generate() signature mismatch: {e}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TTS generation failed: {e}")

    buf = io.BytesIO()
    sf.write(buf, wav, sr, format="WAV")
    return Response(content=buf.getvalue(), media_type="audio/wav")

